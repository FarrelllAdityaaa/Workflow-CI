name: CI - Automated Retraining and Docker Build

# Trigger: Jalan otomatis saat ada push ke branch main
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci-mlops-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write # Wajib untuk push Docker Image

    steps:
      # Mengambil kode terbaru dari repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Setup Python 3.9 Environment
      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.9' 

      # Instal Dependencies Model (Kunci versi)
      # Langkah ini menggabungkan 'Setup Python Env' dan 'Install Dependencies'
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Menginstal semua library yang dibutuhkan model dengan versi terkunci
          pip install pandas==2.2.2 numpy==1.26.4 scikit-learn==1.4.2 mlflow==2.13.0
          
      # Run Training/Modeling (CI Retraining)
      - name: Run MLflow Project (Training)
        run: |
          # Menggunakan --env-manager=local karena dependensi sudah terinstal
          mlflow run MLProject --env-manager=local

      # Log in ke Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # Build Docker Image
      - name: Build Docker Image from Run Artifact
        run: |
          # Ambil Run ID terbaru dari folder mlruns lokal runner
          RUN_ID=$(ls -td mlruns/0/*/ | head -n 1 | cut -d'/' -f3)
          IMAGE_NAME=${{ secrets.DOCKER_HUB_USERNAME }}/titanic-ci:latest
          
          echo "Latest Run ID found: $RUN_ID"
          
          # Build image menggunakan model dari Run ID lokal
          mlflow models build-docker --model-uri "runs:/$RUN_ID/model" --name "$IMAGE_NAME"

      # Push Docker Image
      - name: Push Docker Image to Hub
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_HUB_USERNAME }}/titanic-ci:latest
          docker push $IMAGE_NAME
